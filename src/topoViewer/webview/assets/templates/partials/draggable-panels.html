<script>
  // Draggable Panels Manager with WindowManager Integration
  // Wait for the main bundle to load before initializing
  (function () {
    function initWindowManager() {
      // Wait for window manager to be available from the main bundle
      if (!window.panelManager || !window.windowManager) {
        // Retry in 50ms if not loaded yet
        setTimeout(initWindowManager, 50);
        return;
      }

      const { panelManager, windowManager, defaultPanelConfigs } = window;

      // Check if unified floating panel is locked
      function isUnifiedPanelLocked() {
        const savedState = localStorage.getItem("unifiedPanelState");
        if (savedState) {
          try {
            const state = JSON.parse(savedState);
            return state.locked || false;
          } catch (e) {
            console.warn("Failed to parse unified panel state:", e);
          }
        }
        return false;
      }

      // Get navbar height to calculate proper bounds
      function getNavbarHeight() {
        const navbar = document.querySelector(".navbar");
        return navbar ? navbar.offsetHeight : 72; // Default to 72px (4.5rem) if not found
      }

      // Initialize all draggable panels with window manager
      function initializeAllDraggablePanels() {
        const draggablePanels = document.querySelectorAll(".draggable-panel");
        const navbarHeight = getNavbarHeight();

        draggablePanels.forEach((panel) => {
          const panelId = panel.id;

          // Skip unified floating panel (it has its own management)
          if (panelId === "unified-floating-panel") {
            return;
          }

          // Skip if already registered
          if (panelManager.getPanel(panelId)) {
            console.log(`Panel ${panelId} already registered, skipping`);
            return;
          }

          // Find matching config
          const config = defaultPanelConfigs.find((c) => c.id === panelId);

          if (config) {
            // Register with window manager
            const managedWindow = panelManager.registerPanel({
              ...config,
              element: panel,
              defaultX: config.defaultX ?? 100,
              defaultY: config.defaultY ?? navbarHeight + 20
            });

            console.log(`Registered panel: ${panelId}`, managedWindow);

            // Update draggability based on lock state
            if (managedWindow && isUnifiedPanelLocked()) {
              managedWindow.config.draggable = false;
            }
          } else {
            // Panel not in default configs, create basic config
            const managedWindow = panelManager.registerPanel({
              id: panelId,
              element: panel,
              defaultX: 100,
              defaultY: navbarHeight + 20,
              defaultWidth: 400,
              defaultHeight: 500,
              persistState: true
            });
            console.log(`Registered panel (generic): ${panelId}`, managedWindow);
          }
        });
      }

      // Update draggability of all panels based on lock state
      function updatePanelDraggability() {
        const locked = isUnifiedPanelLocked();
        panelManager.getAllPanels().forEach((win) => {
          win.config.draggable = !locked;

          // Update cursor on title bar
          const titleBar = win.element.querySelector(".panel-title-bar");
          if (titleBar) {
            titleBar.style.cursor = locked ? "default" : "move";
          }
        });
      }

      // Wire up close buttons for all panels
      function setupPanelCloseButtons() {
        document.querySelectorAll(".panel-close-btn").forEach((closeBtn) => {
          // Skip if already set up
          if (closeBtn.dataset.listenerAttached === "true") {
            return;
          }
          closeBtn.dataset.listenerAttached = "true";

          // Add click listener
          closeBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            const panel = closeBtn.closest(".draggable-panel");
            if (panel) {
              const managedWindow = panelManager.getPanel(panel.id);
              if (managedWindow) {
                managedWindow.close();
              } else {
                // Fallback for panels not managed by window manager
                panel.style.display = "none";
              }
            }
          });
        });
      }

      // Initial setup
      initializeAllDraggablePanels();
      setupPanelCloseButtons();
      updatePanelDraggability();

      // Listen for unified panel lock state changes
      let lastLockState = isUnifiedPanelLocked();
      setInterval(() => {
        const currentLockState = isUnifiedPanelLocked();
        if (currentLockState !== lastLockState) {
          lastLockState = currentLockState;
          updatePanelDraggability();
        }
      }, 100); // Check every 100ms

      // Re-initialize when DOM changes (for dynamically added panels)
      const mainObserver = new MutationObserver((mutations) => {
        const hasAddedNodes = mutations.some((mutation) => mutation.addedNodes.length > 0);
        if (hasAddedNodes) {
          initializeAllDraggablePanels();
          setupPanelCloseButtons();
        }
      });

      mainObserver.observe(document.body, {
        childList: true,
        subtree: true
      });

      console.log("Window Manager initialized successfully");
    }

    // Start initialization when DOM is ready
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", initWindowManager);
    } else {
      initWindowManager();
    }
  })();
</script>
