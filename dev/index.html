<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>React TopoViewer - Dev Mode</title>
    <style>
      /* CSS variables are now injected by devTheme.ts via CssBaseline :root overrides */

      html,
      body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
      }

      body {
        background-color: var(--vscode-editor-background);
        color: var(--vscode-editor-foreground);
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell,
          sans-serif;
      }

      #root {
        width: 100%;
        height: 100%;
        transition: width 0.3s ease;
      }

      #root.split-view-active {
        width: 70%;
      }

      /* Dev mode indicator */
      .dev-mode-banner {
        position: fixed;
        top: 0;
        left: 50%;
        transform: translateX(-50%);
        background: #ff6b00;
        color: white;
        padding: 4px 12px;
        font-size: 11px;
        font-weight: bold;
        z-index: 10000;
        border-radius: 0 0 4px 4px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      }

      /* Dev Settings Panel */
      .dev-settings-toggle {
        position: fixed;
        bottom: 12px;
        right: 12px;
        width: 36px;
        height: 36px;
        background: var(--vscode-button-background);
        color: var(--vscode-button-foreground);
        border: none;
        border-radius: 50%;
        cursor: pointer;
        font-size: 16px;
        z-index: 10001;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        transition: transform 0.2s;
      }
      .dev-settings-toggle:hover {
        background: var(--vscode-button-hoverBackground);
        transform: scale(1.1);
      }
      .dev-settings-panel {
        position: fixed;
        bottom: 56px;
        right: 12px;
        width: 280px;
        background: var(--vscode-sideBar-background);
        border: 1px solid var(--vscode-panel-border);
        border-radius: 8px;
        padding: 16px;
        z-index: 10000;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        display: none;
      }
      .dev-settings-panel.open {
        display: block;
      }
      .dev-settings-panel h3 {
        margin: 0 0 12px 0;
        font-size: 13px;
        font-weight: 600;
        color: var(--vscode-foreground);
        border-bottom: 1px solid var(--vscode-panel-border);
        padding-bottom: 8px;
      }
      .dev-settings-section {
        margin-bottom: 14px;
      }
      .dev-settings-section:last-child {
        margin-bottom: 0;
      }
      .dev-settings-label {
        font-size: 11px;
        color: var(--vscode-descriptionForeground);
        margin-bottom: 6px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .dev-settings-buttons {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
      }
      .dev-settings-btn {
        background: var(--vscode-button-secondaryBackground);
        color: var(--vscode-button-secondaryForeground);
        border: none;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 11px;
        transition: background 0.15s;
      }
      .dev-settings-btn:hover {
        background: var(--vscode-button-secondaryHoverBackground);
      }
      .dev-settings-btn.active {
        background: var(--vscode-button-background);
        color: var(--vscode-button-foreground);
      }
      .dev-settings-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .dev-settings-switch {
        position: relative;
        width: 36px;
        height: 20px;
        background: var(--vscode-input-background);
        border-radius: 10px;
        cursor: pointer;
        transition: background 0.2s;
      }
      .dev-settings-switch.on {
        background: var(--vscode-button-background);
      }
      .dev-settings-switch::after {
        content: "";
        position: absolute;
        top: 2px;
        left: 2px;
        width: 16px;
        height: 16px;
        background: white;
        border-radius: 50%;
        transition: left 0.2s;
      }
      .dev-settings-switch.on::after {
        left: 18px;
      }

      /* Split View Panel - positioned below navbar (4.5rem = 72px) */
      #splitViewPanel {
        position: fixed;
        top: 4.5rem;
        right: 0;
        width: 0;
        height: calc(100% - 4.5rem);
        background: var(--vscode-sideBar-background);
        border-left: 1px solid var(--vscode-panel-border);
        overflow: hidden;
        transition: width 0.3s ease;
        display: flex;
        flex-direction: column;
        z-index: 40;
      }
      #splitViewPanel.open {
        width: 30%;
      }
      .split-view-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 12px;
        background: var(--vscode-tab-activeBackground);
        border-bottom: 1px solid var(--vscode-panel-border);
      }
      .split-view-header span {
        font-size: 12px;
        font-weight: 500;
        color: var(--vscode-foreground);
      }
      .split-view-close {
        background: none;
        border: none;
        color: var(--vscode-foreground);
        cursor: pointer;
        padding: 4px 8px;
        font-size: 14px;
        opacity: 0.7;
      }
      .split-view-close:hover {
        opacity: 1;
      }
      .split-view-content {
        flex: 1;
        overflow: hidden;
        padding: 0;
        display: flex;
        flex-direction: column;
        min-height: 0;
      }
      .split-view-section {
        display: flex;
        flex-direction: column;
        flex: 1 1 50%;
        min-height: 0;
      }
      .split-view-section-label {
        padding: 6px 10px;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--vscode-descriptionForeground);
        background: var(--vscode-editor-background);
        border-bottom: 1px solid var(--vscode-panel-border);
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .split-view-label-text {
        flex: 1;
        min-width: 0;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .split-view-dirty {
        color: #f4b400;
        font-size: 12px;
        visibility: hidden;
      }
      .split-view-save {
        background: var(--vscode-button-background);
        color: var(--vscode-button-foreground);
        border: 1px solid transparent;
        border-radius: 4px;
        padding: 2px 6px;
        font-size: 10px;
        font-weight: 600;
        text-transform: none;
        letter-spacing: 0;
        cursor: pointer;
      }
      .split-view-save:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .split-view-save-all {
        margin-left: 8px;
      }
      .split-view-editor {
        flex: 1 1 auto;
        min-height: 140px;
        background: var(--vscode-editor-background);
      }
      /* Split view uses position:fixed, #root shrinks via split-view-active class */
    </style>
  </head>
  <body>
    <div class="dev-mode-banner">DEV MODE - Vite HMR Active</div>

    <!-- Settings Toggle Button -->
    <button class="dev-settings-toggle" onclick="toggleSettingsPanel()" title="Dev Settings">
      ⚙
    </button>

    <!-- Settings Panel -->
    <div class="dev-settings-panel" id="devSettingsPanel">
      <h3>Dev Settings</h3>

      <div class="dev-settings-section">
        <div class="dev-settings-label">Topology Files</div>
        <div style="display: flex; gap: 6px; align-items: center">
          <select
            id="topologyFileSelect"
            onchange="loadSelectedFile()"
            style="
              flex: 1;
              padding: 5px 8px;
              background: var(--vscode-dropdown-background);
              color: var(--vscode-dropdown-foreground);
              border: 1px solid var(--vscode-dropdown-border);
              border-radius: 4px;
              font-size: 11px;
              cursor: pointer;
            "
          >
            <option value="">Loading...</option>
          </select>
          <button class="dev-settings-btn" onclick="refreshFileList()" title="Refresh file list">
            ↻
          </button>
        </div>
        <div style="display: flex; gap: 6px; align-items: center; margin-top: 6px">
          <button
            class="dev-settings-btn"
            onclick="resetFiles()"
            title="Reset all files to original state"
            style="color: #f44336; flex: 1"
          >
            ⟲ Reset Files
          </button>
        </div>
        <div
          id="fileLoadStatus"
          style="font-size: 10px; color: var(--vscode-descriptionForeground); margin-top: 4px"
        ></div>
      </div>

      <div class="dev-settings-section">
        <div class="dev-settings-label">Mode</div>
        <div class="dev-settings-buttons">
          <button class="dev-settings-btn active" id="modeEdit" onclick="setMode('edit')">
            Edit
          </button>
          <button class="dev-settings-btn" id="modeView" onclick="setMode('view')">View</button>
        </div>
      </div>

      <div class="dev-settings-section">
        <div class="dev-settings-label">Split View</div>
        <div class="dev-settings-buttons">
          <button class="dev-settings-btn" id="splitViewBtn" onclick="toggleSplitView()">
            Toggle YAML + Annotations
          </button>
        </div>
      </div>

      <div class="dev-settings-section">
        <div class="dev-settings-row">
          <div class="dev-settings-label" style="margin-bottom: 0">Light Theme</div>
          <div class="dev-settings-switch" id="themeSwitch" onclick="toggleTheme()"></div>
        </div>
      </div>
    </div>

    <div id="root"></div>

    <!-- Split View Panel (must come after #root for flexbox to position on right) -->
    <div id="splitViewPanel">
      <div class="split-view-header">
        <div style="display: flex; align-items: center; gap: 6px">
          <span id="splitViewFilePath">No file loaded</span>
          <button
            class="split-view-save split-view-save-all"
            id="splitViewSaveAll"
            onclick="saveAllSplitView()"
            title="Save all"
          >
            Save All
          </button>
        </div>
        <button class="split-view-close" onclick="toggleSplitView()" title="Close">&times;</button>
      </div>
      <div class="split-view-content">
        <div class="split-view-section">
          <div class="split-view-section-label">
            <span class="split-view-label-text" id="splitViewYamlLabel">topology.clab.yml</span>
            <span class="split-view-dirty" id="splitViewYamlDirty" aria-hidden="true">●</span>
            <button
              class="split-view-save"
              id="splitViewYamlSave"
              onclick="saveYamlSplitView()"
              title="Save YAML"
            >
              Save
            </button>
          </div>
          <div class="split-view-editor" id="yamlEditor"></div>
        </div>
        <div class="split-view-section">
          <div class="split-view-section-label">
            <span class="split-view-label-text" id="splitViewAnnotLabel">
              topology.annotations.json
            </span>
            <span class="split-view-dirty" id="splitViewAnnotDirty" aria-hidden="true">●</span>
            <button
              class="split-view-save"
              id="splitViewAnnotSave"
              onclick="saveAnnotationsSplitView()"
              title="Save annotations"
            >
              Save
            </button>
          </div>
          <div class="split-view-editor" id="annotationsEditor"></div>
        </div>
      </div>
    </div>

    <script>
      function toggleSettingsPanel() {
        document.getElementById("devSettingsPanel").classList.toggle("open");
      }

      function toggleTheme() {
        const isLight = document.documentElement.classList.toggle("light");
        document.getElementById("themeSwitch").classList.toggle("on", isLight);
        if (window.__DEV__) window.__DEV__.updateSplitViewTheme();
      }

      function setMode(mode) {
        if (window.__DEV__) window.__DEV__.setMode(mode);
        document.getElementById("modeEdit").classList.toggle("active", mode === "edit");
        document.getElementById("modeView").classList.toggle("active", mode === "view");
      }

      function toggleSplitView() {
        if (window.__DEV__) window.__DEV__.toggleSplitView();
      }

      function saveYamlSplitView() {
        if (window.__DEV__) window.__DEV__.saveSplitViewYaml();
      }

      function saveAnnotationsSplitView() {
        if (window.__DEV__) window.__DEV__.saveSplitViewAnnotations();
      }

      function saveAllSplitView() {
        if (window.__DEV__) window.__DEV__.saveSplitViewAll();
      }

      // Reset all files to original state
      async function resetFiles() {
        updateFileStatus("Resetting files...");

        try {
          const response = await fetch("/api/reset", { method: "POST" });
          const result = await response.json();

          if (!result.success) {
            throw new Error(result.error || "Failed to reset files");
          }

          // Reload the page
          window.location.reload();
        } catch (error) {
          console.error("Failed to reset files:", error);
          updateFileStatus("Error: " + error.message);
        }
      }

      // File selector functions
      async function refreshFileList() {
        const select = document.getElementById("topologyFileSelect");
        select.innerHTML = '<option value="">Loading...</option>';
        updateFileStatus("Refreshing file list...");

        try {
          const response = await fetch("/files");
          const files = await response.json();

          if (!Array.isArray(files)) {
            throw new Error("Invalid response from /files endpoint");
          }

          select.innerHTML = '<option value="">-- Select a file --</option>';
          for (const file of files) {
            const option = document.createElement("option");
            option.value = file.path;
            option.textContent = file.filename + (file.hasAnnotations ? " (+ annotations)" : "");
            select.appendChild(option);
          }

          updateFileStatus("Found " + files.length + " topology files");

          // Select current file if one is loaded
          if (window.__DEV__) {
            const currentFile = window.__DEV__.getCurrentFile();
            if (currentFile) {
              select.value = currentFile;
            }
          }
        } catch (error) {
          console.error("Failed to load file list:", error);
          select.innerHTML = '<option value="">Error loading files</option>';
          updateFileStatus("Error: " + error.message);
        }
      }

      async function loadSelectedFile() {
        const select = document.getElementById("topologyFileSelect");
        const filename = select.value;

        if (!filename) return;

        updateFileStatus("Loading " + filename + "...");

        try {
          if (window.__DEV__) {
            await window.__DEV__.loadTopologyFile(filename);
            updateFileStatus("Loaded: " + filename);

            // Update split view labels
            document.getElementById("splitViewFilePath").textContent = "File: " + filename;
            document.getElementById("splitViewYamlLabel").textContent = filename;
            document.getElementById("splitViewAnnotLabel").textContent =
              filename + ".annotations.json";
          }
        } catch (error) {
          console.error("Failed to load file:", error);
          updateFileStatus("Error: " + error.message);
        }
      }

      function updateFileStatus(message) {
        const status = document.getElementById("fileLoadStatus");
        if (status) {
          status.textContent = message;
        }
      }

      // Close panel when clicking outside
      document.addEventListener("click", function (e) {
        const panel = document.getElementById("devSettingsPanel");
        const toggle = document.querySelector(".dev-settings-toggle");
        if (!panel.contains(e.target) && !toggle.contains(e.target)) {
          panel.classList.remove("open");
        }
      });

      // Initialize file list when page loads and __DEV__ is available
      function initFileSelector() {
        if (window.__DEV__) {
          refreshFileList();
        } else {
          // Wait for __DEV__ to be available
          setTimeout(initFileSelector, 100);
        }
      }

      // Start initialization
      setTimeout(initFileSelector, 200);
    </script>
    <script type="module" src="./main.tsx"></script>
  </body>
</html>
